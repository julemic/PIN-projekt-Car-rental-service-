@model List<CarRentalService.Models.Rental>

@{
    ViewData["Title"] = "My Rentals";
}

<div class="myrentals-page" style="padding-bottom:140px;">
    <h1>My Rentals</h1>

    @if (TempData["Msg"] != null)
    {
        <p style="color:green; font-weight:600; margin-bottom:20px;">
            @TempData["Msg"]
        </p>
    }

    @if (!Model.Any())
    {
        <p>You currently have no active rentals.</p>
    }
    else
    {
        <div style="display:flex; flex-wrap:wrap; gap:20px; margin-top:20px;">
            @foreach (var r in Model)
            {
                <div style="width:340px; border:2px solid black; padding:14px;">

                    <h3 style="margin-bottom:6px;">
                        @r.Vehicle?.Brand @r.Vehicle?.Model
                    </h3>

                    <div style="font-size:14px; margin-bottom:4px;">
                        <b>Pickup:</b> @r.Pickup.ToString("dd.MM.yyyy HH:mm")
                    </div>

                    <div style="font-size:14px; margin-bottom:10px;">
                        <b>Return:</b> @r.Return.ToString("dd.MM.yyyy HH:mm")
                    </div>

                    <div style="font-size:14px; margin-bottom:10px;">
                        <b>Insurance:</b> @r.InsuranceName (@r.InsurancePricePerDay € / day)
                    </div>

                    <div style="font-size:14px; margin-bottom:12px;">
                        <b>Total:</b> @r.TotalPrice € ( @r.TotalDays days × @r.TotalPricePerDay € )
                    </div>

                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <!-- RETURN CAR -->
                        <form method="post" asp-action="ReturnCar" style="margin:0;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="rentalId" value="@r.Id" />
                            <button type="submit" class="btn">Return car</button>
                        </form>

                        <!-- ACCIDENT REPORT (opens modal) -->
                        <button type="button"
                                class="btn"
                                onclick="openAccident(
                                    @r.Id,
                                    @(r.Vehicle?.Id ?? 0),
                                    '@(r.Vehicle?.Brand ?? "")',
                                    '@(r.Vehicle?.Model ?? "")',
                                    '@(r.Vehicle?.Category ?? "")'
                                )">
                            Accident report
                        </button>

                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- MODAL -->
<div id="accidentModal"
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000;">
    <div style="
        max-width:640px;
        background:white;
        margin:60px auto;
        padding:18px;
        border-radius:10px;
        max-height:80vh;
        overflow-y:auto;
">


        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0;">Accident report</h2>
            <button type="button" class="btn" onclick="closeAccident()">Close</button>
        </div>

        <form method="post" asp-action="AccidentReportPdf">
            @Html.AntiForgeryToken()

            <input type="hidden" name="RentalId" id="RentalId" value="0" />

            <input type="hidden" name="VehicleId" id="VehicleId" />
            <input type="hidden" name="VehicleBrand" id="VehicleBrand" />
            <input type="hidden" name="VehicleModel" id="VehicleModel" />
            <input type="hidden" name="VehicleCategory" id="VehicleCategory" />


            <div style="border:1px solid #ddd; padding:12px; border-radius:8px; margin-bottom:16px;">
                <div style="font-weight:700; margin-bottom:6px;">Vehicle information</div>

                <div><b>ID:</b> <span id="vIdText"></span></div>
                <div><b>Brand:</b> <span id="vBrandText"></span></div>
                <div><b>Model:</b> <span id="vModelText"></span></div>
                <div><b>Category:</b> <span id="vCategoryText"></span></div>
            </div>


            <div style="display:flex; gap:12px; flex-wrap:wrap;">
                <div style="flex:1;">
                    <label>Full name</label>
                    <input name="FullName" class="form-control" />
                </div>
                <div style="flex:1;">
                    <label>Email</label>
                    <input name="Email" class="form-control" type="email" />
                </div>
            </div>

            <div style="margin-top:12px;">
                <label>Phone (optional)</label>
                <input name="Phone" class="form-control" />
            </div>

            <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;">
                <div style="flex:1;">
                    <label>Accident date & time</label>
                    <input name="AccidentDate" class="form-control" type="datetime-local" />
                </div>
                <div style="flex:1;">
                    <label>Location</label>
                    <input name="Location" class="form-control" />
                </div>
            </div>

            <div style="margin-top:12px;">
                <label style="display:flex; gap:8px; align-items:center;">
                    <input type="checkbox" name="PoliceReported" value="true" />
                    Police reported
                </label>
            </div>

            <div style="margin-top:12px;">
                <label>Other party (optional)</label>
                <input name="OtherParty" class="form-control" />
            </div>

            <div style="margin-top:12px;">
                <label>Description</label>
                <textarea name="Description" class="form-control" rows="5"></textarea>
            </div>

            <div style="margin-top:16px;">
                <button type="submit" class="btn">Save as PDF</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        function openAccident(rentalId, vehicleId, brand, model, category) {

            // hidden inputi (za PDF / backend)
            document.getElementById("RentalId").value = rentalId;
            document.getElementById("VehicleId").value = vehicleId;
            document.getElementById("VehicleBrand").value = brand;
            document.getElementById("VehicleModel").value = model;
            document.getElementById("VehicleCategory").value = category;

            // to su vidljivi podaci
            document.getElementById("vIdText").innerText = vehicleId || "-";
            document.getElementById("vBrandText").innerText = brand || "-";
            document.getElementById("vModelText").innerText = model || "-";
            document.getElementById("vCategoryText").innerText = category || "-";

            document.getElementById("accidentModal").style.display = "block";
        }

        function closeAccident() {
            document.getElementById("accidentModal").style.display = "none";
        }
    </script>

}

