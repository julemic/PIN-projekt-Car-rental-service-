@model CarRentalService.Models.CarsSearchVm
@using CarRentalService.Models

@{
    ViewData["Title"] = "Cars";

    var showVehicles = ViewBag.ShowVehicles as bool? ?? false;
    var vehicles = ViewBag.Vehicles as List<Vehicle> ?? new List<Vehicle>();
    var categories = ViewBag.Categories as List<string> ?? new List<string> { "All offers" };
    var selectedCategory = ViewBag.SelectedCategory as string ?? "All offers";
    var availableMap = ViewBag.AvailableMap as Dictionary<int, int> ?? new Dictionary<int, int>();
}

<div class="container mt-4 mb-5">

    <h1 class="mb-4">Cars</h1>

    <form asp-action="Cars" asp-controller="Home" method="post">
        @Html.AntiForgeryToken()

        <div asp-validation-summary="All" class="text-danger mb-3"></div>

        <div class="row mb-4">

            <div class="col-md-4">
                <label asp-for="Pickup" class="form-label"></label>
                <input asp-for="Pickup" type="date" class="form-control" />
                <span asp-validation-for="Pickup" class="text-danger"></span>
            </div>

            <div class="col-md-4">
                <label asp-for="Return" class="form-label"></label>
                <input asp-for="Return" type="date" class="form-control" />
                <span asp-validation-for="Return" class="text-danger"></span>
            </div>

            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-danger w-100">
                    Search
                </button>
            </div>

        </div>

        @if (TempData["Msg"] != null)
        {
            <div class="alert alert-success">
                @TempData["Msg"]
            </div>
        }

        @if (showVehicles)
        {
            <hr />

            <!-- INSURANCE -->
            <div class="card shadow-sm mb-4">
                <div class="card-header fw-bold">
                    Choose insurance
                </div>

                <div class="card-body">

                    
                    <div class="form-check mb-3 p-3 border rounded">
                        <input class="form-check-input"
                               asp-for="SelectedInsurancePlan"
                               type="radio"
                               value="Basic"
                               id="basicPlan" />

                        <label class="form-check-label w-100" for="basicPlan">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>BASIC protect</strong><br />
                                    <small class="text-muted">
                                        ✔ Basic liability coverage<br />
                                        ✔ Mandatory insurance included<br />
                                        ✖ No damage reduction
                                    </small>
                                </div>
                                <div class="fw-bold">
                                    0 € / day
                                </div>
                            </div>
                        </label>
                    </div>

                    
                    <div class="form-check mb-3 p-3 border rounded">
                        <input class="form-check-input"
                               asp-for="SelectedInsurancePlan"
                               type="radio"
                               value="Medium"
                               id="mediumPlan" />

                        <label class="form-check-label w-100" for="mediumPlan">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>MEDIUM protect</strong><br />
                                    <small class="text-muted">
                                        ✔ Reduced damage liability<br />
                                        ✔ Passenger insurance<br />
                                        ✔ Partial theft protection
                                    </small>
                                </div>
                                <div class="fw-bold">
                                    17 € / day
                                </div>
                            </div>
                        </label>
                    </div>

                    
                    <div class="form-check p-3 border rounded">
                        <input class="form-check-input"
                               asp-for="SelectedInsurancePlan"
                               type="radio"
                               value="Total"
                               id="totalPlan" />

                        <label class="form-check-label w-100" for="totalPlan">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>TOTAL protect</strong><br />
                                    <small class="text-muted">
                                        ✔ Full damage coverage<br />
                                        ✔ Theft protection<br />
                                        ✔ No excess / no hidden costs
                                    </small>
                                </div>
                                <div class="fw-bold">
                                    22 € / day
                                </div>
                            </div>
                        </label>
                    </div>

                    <span asp-validation-for="SelectedInsurancePlan"
                          class="text-danger d-block mt-2"></span>

                </div>
            </div>


            <!-- FILTER + SORT -->
            <div class="d-flex mb-4 align-items-center">

                <div class="me-3">
                    <button type="submit" name="Category" value="All offers" class="btn btn-outline-dark btn-sm">
                        All offers
                    </button>

                    @foreach (var c in categories.Where(x => x != "All offers"))
                    {
                        <button type="submit" name="Category" value="@c" class="btn btn-outline-dark btn-sm">
                            @c
                        </button>
                    }
                </div>

                <div class="ms-auto">
                    <select name="Sort" onchange="this.form.submit()" class="form-select form-select-sm">
                        <option value="">Sort by</option>
                        <option value="price_asc" selected="@(ViewBag.Sort == "price_asc")">
                            Price (lowest)
                        </option>
                        <option value="price_desc" selected="@(ViewBag.Sort == "price_desc")">
                            Price (highest)
                        </option>
                    </select>
                </div>

            </div>

            <!-- VEHICLES -->
    @if (!vehicles.Any())
    {
                <p>No vehicles found.</p>
    }
    else
    {
                <div class="row">
                    @foreach (var v in vehicles)
                    {
                        var available = availableMap.TryGetValue(v.Id, out var a)
                        ? a
                        : v.TotalQuantity;

                        <div class="col-md-3 mb-4">
                            <div class="card h-100 @(available <= 0 ? "opacity-50" : "")">

                                <img src="~/images/@v.ImageUrl"
                                     class="card-img-top"
                                     style="height:160px; object-fit:contain; padding:15px;"
                                     alt="@v.Brand @v.Model" />

                                <div class="card-body">
                                    <h5>@v.Brand @v.Model</h5>
                                    <p><b>@v.DailyPrice €</b> / day</p>
                                    <p>Available: <b>@available</b></p>

                                    @if (available > 0)
                                    {
                                        <button type="submit"
                                                name="VehicleId"
                                                value="@v.Id"
                                                formaction="@Url.Action("Rent", "Home")"
                                                class="btn btn-danger w-100">
                                            RENT NOW
                                        </button>
                                    }
                                    else
                                    {
                                        <button type="button"
                                                class="btn btn-secondary w-100"
                                                disabled>
                                            NOT AVAILABLE
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
                }
    }

    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const pickup = document.querySelector('input[name="Pickup"]');
        const ret = document.querySelector('input[name="Return"]');

        function syncMin() {
            if (pickup && ret && pickup.value)
                ret.min = pickup.value;
        }

        pickup?.addEventListener('change', syncMin);
        syncMin();
    </script>
}
