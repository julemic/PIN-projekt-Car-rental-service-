@model CarRentalService.Models.CarsSearchVm
@using CarRentalService.Models

@{
    ViewData["Title"] = "Cars";

    var showVehicles = ViewBag.ShowVehicles as bool? ?? false;
    var vehicles = ViewBag.Vehicles as List<Vehicle> ?? new List<Vehicle>();

    var categories = ViewBag.Categories as List<string> ?? new List<string> { "All offers" };
    var selectedCategory = ViewBag.SelectedCategory as string ?? "All offers";
    var availableMap = ViewBag.AvailableMap as Dictionary<int, int> ?? new Dictionary<int, int>();
}

<div class="cars-page" style="padding-bottom:160px;">

    <h1>Cars</h1>

    <form asp-action="Cars" method="post" style="margin-top:20px;">
        @Html.AntiForgeryToken()

        <!-- DATUMI -->
        <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end;">
            <div>
                <label asp-for="Pickup"></label><br />
                <input asp-for="Pickup" type="datetime-local" />
                <span asp-validation-for="Pickup" style="color:red;"></span>
            </div>

            <div>
                <label asp-for="Return"></label><br />
                <input asp-for="Return" type="datetime-local" />
                <span asp-validation-for="Return" style="color:red;"></span>
            </div>

            <button type="submit" class="btn">Search</button>
        </div>

        <span asp-validation-summary="ModelOnly"
              style="color:red; display:block; margin-top:10px;"></span>

        @if (TempData["Msg"] != null)
        {
            <p style="margin-top:10px; color:green; font-weight:600;">
                @TempData["Msg"]
            </p>
        }

        @if (showVehicles)
        {
            <hr style="margin:24px 0;" />

            <!-- INSURANCE -->
            <div style="border:1px solid #eee; padding:18px; border-radius:12px; margin-bottom:24px;">
                <div style="font-weight:800; font-size:22px; margin-bottom:10px;">
                    Choose insurance
                </div>

                <div style="display:flex; flex-direction:column; gap:14px;">

                    <label style="display:flex; gap:12px; padding:12px; border-top:1px solid #eee;">
                        <input asp-for="SelectedInsurancePlan" type="radio" value="Basic" />
                        <div style="flex:1;">
                            <b>BASIC protect</b><br />
                            Basic coverage – no extra cost.
                        </div>
                        <b>0 € / day</b>
                    </label>

                    <label style="display:flex; gap:12px; padding:12px; border-top:1px solid #eee;">
                        <input asp-for="SelectedInsurancePlan" type="radio" value="Medium" />
                        <div style="flex:1;">
                            <b>MEDIUM protect</b><br />
                            Reduced liability & passenger coverage.
                        </div>
                        <b>17 € / day</b>
                    </label>

                    <label style="display:flex; gap:12px; padding:12px; border-top:1px solid #eee; border-bottom:1px solid #eee;">
                        <input asp-for="SelectedInsurancePlan" type="radio" value="Total" />
                        <div style="flex:1;">
                            <b>TOTAL protect</b><br />
                            Maximum protection.
                        </div>
                        <b>22 € / day</b>
                    </label>
                </div>

                <span asp-validation-for="SelectedInsurancePlan"
                      style="color:red; display:block; margin-top:8px;"></span>
            </div>

            <!-- FILTER + SORT -->
            <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:24px;">

                <button type="submit" name="Category" value="All offers" class="btn">
                    All offers
                </button>

                @foreach (var c in categories.Where(x => x != "All offers"))
                {
                    <button type="submit" name="Category" value="@c" class="btn">
                        @c
                    </button>
                }

                <div style="margin-left:auto;">
                    <select name="Sort" onchange="this.form.submit()"
                            style="padding:10px 14px; border-radius:10px;">
                        <option value="">Sort by</option>
                        <option value="price_asc" selected="@(ViewBag.Sort == "price_asc")">
                            Price (lowest)
                        </option>
                        <option value="price_desc" selected="@(ViewBag.Sort == "price_desc")">
                            Price (highest)
                        </option>
                    </select>
                </div>
            </div>

            <!-- VEHICLES -->
            @if (!vehicles.Any())
            {
                <p>No vehicles found.</p>
            }
            else
            {
                <div style="display:flex; flex-wrap:wrap; gap:16px;">
                    @foreach (var v in vehicles)
                    {
                        var available = availableMap.TryGetValue(v.Id, out var a)
                        ? a
                        : v.TotalQuantity;

                        <div style="width:280px; border:2px solid black; padding:12px;
                                                opacity:@(available <= 0 ? "0.5" : "1")">

                            <img src="@v.ImageUrl"
                                 alt="@v.Brand @v.Model"
                                 style="width:100%; height:160px; object-fit:contain;" />

                            <h3>@v.Brand @v.Model</h3>

                            <div><b>@v.DailyPrice €</b> / day</div>
                            <div>Available: <b>@available</b></div>

                            @if (available > 0)
                            {
                                <button type="submit"
                                        name="VehicleId"
                                        value="@v.Id"
                                        formaction="@Url.Action("Rent", "Home")"
                                        class="btn"
                                        style="margin-top:10px;">
                                    RENT NOW
                                </button>
                            }
                            else
                            {
                                <button type="button" class="btn" disabled style="margin-top:10px;">
                                    NOT AVAILABLE
                                </button>
                            }
                        </div>
                    }
                </div>
            }
        }
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const pickup = document.querySelector('input[name="Pickup"]');
        const ret = document.querySelector('input[name="Return"]');

        function syncMin() {
            if (pickup && ret && pickup.value) ret.min = pickup.value;
        }

        pickup?.addEventListener('change', syncMin);
        syncMin();
    </script>
}
